#The Crowbar Framework#
##Architecture##
Crowbar provides a modular platform containing the building blocks to provision, monitor, and operate a large-scale cloud deployment. Starting with bare metal installation, Crowbar automates all the required installation and configuration tasks. The core capabilities provided are:

- Hardware configuration—updating and configuring BIOS and BMC boards
- Deployment of base operating system
- Deployment of cloud components
- Providing core network infrastructure services (NTP, DNS, DHCP)
- Monitoring availability and performance of all deployed components

To accomplish this, Crowbar is installed on a dedicated administration node. From this admin node, Crowbar manages the initial discovery and configuration of the other nodes in the system. Each function in the cloud is controlled by a Crowbar component called a barclamp. There are barclamps for Nagios®, Ganglia, NTP, and a variety of other basic infrastructure services. Each barclamp is responsible for all the aspects of the underlying technology required to make it usable. To control the operation of a barclamp, you create a proposal for the barclamp (or may edit one already in place). A proposal comprises several parts:

- Parameters to customize the operation of the barclamp; for example: upstream DNS resolvers. 
- List of machines in the deployment that fulfill the different roles in the barclamp.
- Internal system information.

When provisioning a function, you start with a proposal generated by Crowbar. Each core service running on the admin server has a default proposal included as part of the Crowbar installation. You can edit these proposals before installing these services on the admin node.

When a proposal is committed, Crowbar configures the Chef server and other components in the systems (TFTP, DHCP, and so on) to build the setup described in the proposal. Machines in the deployment affected by the proposals have their configuration updated using Chef client-side components. At the end of the process, the function described by the proposal is ready for use.

To allow easy integration into your existing environments, Crowbar allows customization of its barclamps, and additional barclamps can be added. You can disable the default monitoring tools (Nagios® and Ganglia) if you prefer to use your own existing monitoring tools, and internal cloud services can be connected to extant services; for example the cloud’s NTP service can be configured to synchronize with existing servers.

Finally, a cloud deployment is dynamic. Machines come and go, break down, or get re-purposed. Crowbar’s operational model makes sure that machines are hooked into the key infrastructure services. Critical services (for example Nagios® monitoring) are installed automatically on newly provisioned machines by default, and those machines may be easily allocated for use with any additional Crowbar services desired.

##System End State##
The sections that follow describe the services and capabilities available, assuming the system is installed with defaults. As mentioned above, the Crowbar framework allows for many customizations. This section focuses on the primary use cases for Crowbar, namely integrating all the functions into an existing network environment. Later sections describe more advanced customization options.

##Node Provisioning##
When a new node is added to the system, the node should be set up to allow PXE booting. Once a machine is powered on, Crowbar uses the PXE boot protocol to manage the provisioning process.
After a system is fully installed by Crowbar, it has the following characteristics:

- BIOS is updated and configured based on the system’s usage.
- BMC (baseboard management controller) is configured to allow management and IPMI support.
- Base operating system (OS) is installed.
- Administration access to the OS is configured — IP addressing and SSH keys are installed.
- Nagios® and Ganglia monitoring scripts are installed for the functions deployed on the system.
- Chef-client daemon is configured to maintain the system’s state in sync.
- NTP sync client is configured.

Additionally, the system is configured to fulfill the functions that are deployed on it and is added to the appropriate cluster.
Crowbar’s network barclamp carries on responsibilities related to L2/L3 management, namely:

- Networking administration.
- Physical NIC configuration — BMC port allocation (teamed or not).
- VLAN configuration on nodes.
- IP address location service, used by the rest of Crowbar. Addresses can be allocated from different pools, meant for different usages; for example: admin network, BMC, storage, and public.

The above functions involve managing information on the admin node and remotely executing operations on the compute nodes as they are provisioned. On each compute node, NICs are defined to match VLANs and appropriate addressing information is configured.
##NTP##
The admin node runs an NTP server to synchronize time on all the machines in the cluster. Optionally, the NTP server can synchronize with upstream servers, in which case nodes are configured to sync their local time to those servers instead.

>![notes.png](graphics/notes.png "notes.png") Since all nodes in the cluster rely on the admin node, it is important that the time, date, and time zone are correctly set on this node. Crowbar expects the hardware clock on the admin node to be set to the UTC time zone.

##DNS##

The admin node runs a DNS server to allow resolution of internal and (optionally) external names. The DNS server can be configured with the following:

- A list of upstream DNS servers to contact.
- A set of static mappings.
- The default domain name suffix.
- Crowbar makes sure that when a new machine is added to the deployment, it has a default entry added to the DNS zone. The default host name is the machine’s MAC address prefixed by the letter “d” (e.g., *d00-a4-b3-c2-d1-e0.yourdomain.com*).

##Nagios®##

Nagios® monitors provisioned services for availability. Each cluster instance is represented as a host group, letting you quickly identify the health of a given instance.
Crowbar installs the Nagios® server on the admin node and configures it to monitor all the nodes in the system. As new nodes are brought online, Crowbar dynamically updates Nagios® to include them.

##Ganglia##
Ganglia monitors the installed cluster for capacity and performance information, letting you easily gauge the cluster’s capacity and check recent activity.

##Logging##
The admin node serves as a central log repository. Its syslog daemon is configured to accept remote messages and each node is configured to forward all messages there.